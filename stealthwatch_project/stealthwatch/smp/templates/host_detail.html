{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h4> <a href="{% url 'hostgroup_list' %}">{{hostgroup_detail.parentDisplay.name}}</a> > 
            <a href="{% url 'hostgroup_detail' id=hostgroup_detail.id %}">{{hostgroup_detail.name}}</a> > 
            <a href="#">{{host_ip}}</a> 
        </h4>
    </div>
    <div class="card-deck">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">호스트 정보</h6>
            </div>
            <div class="card-body">
                <p>IP: {{host_ip}}</p>
                <p>호스트 그룹: {{hostgroup_detail.name}} </p>
                <p>정책: {{hostgroup_detail.location}}</p>
                <p>Mac 주소: -- </p>
            </div>
        </div>
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">used application (last 5 min)</h6>
            </div>
            <div class="card-body">
                <canvas id="myBarChart"></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Searched Flow (last 5 min) 
                        <a class="float-right" href="{% url 'flow_search' %}?ip={{host_ip}}">detail search <i class="fas fa-search"></i></a>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="display" id="FlowdataTable" width="100%">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Source IP</th>
                                    <th>Source Port/Protocol</th>
                                    <th>Destination IP</th>
                                    <th>Destination Port/Protocol</th>
                                    <th>Destination host group</th>
                                    <th>Application</th>
                                    <th>start time</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <!-- <tbody>
                                {% for flow in results %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ flow.peer.ipAddress }}</td>
                                    <td>{{ flow.peer.portProtocol.port }}/{{ flow.peer.portProtocol.protocol }}</td>
                                    <td>{{ flow.peer.hostGroupname }}</td>
                                    <td>{{ flow.statistics.firstActiveTime }}</td>
                                </tr>
                                {% endfor %}
                            </tbody> -->
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="wrap-loading display-none">
        <img src="{% static 'image/loading.gif' %}" alt="loading" />
    </div> 
</div>
<script src="{% static 'vendor/chart.js/Chart.min.js' %}"></script>
<script>
    $.ajax({
        url: "{% url 'host_detail_data' id=hostgroup_detail.id ip=host_ip%}",
        method: "GET",
        dataType: "json",
        beforeSend:function(){
            $('.wrap-loading').removeClass('display-none');
        },
        complete:function(){
            $('.wrap-loading').addClass('display-none');
        }
     })
    .done(function(data) {
        // console.log(data);
        // $("modal id").show(bs.mosdfsdfd):
        trafficApplicationtop10(data.application_list);
        FlowTable(data.flow_results)
        //  close modal window.
    })
    .fail(function() {
        alert( "error" );
    });

    function trafficApplicationtop10 (chartdata) {
        var applicationID = [];
        var applicationCount = [];
        var insidegroup_traffic = chartdata;
        chartdata.forEach(function(d, i) {
            // console.log(d, i);
            applicationID.push(d.id);
            applicationCount.push(d.count);
            }
        );
        // console.log(grName);
        // console.log(trafficByte);
        var ctx = document.getElementById("myBarChart");
        var myBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: applicationID,
            datasets: [{
                label: 'application count',
                data: applicationCount,
                borderColor: "rgba(255, 201, 14, 1)",
                backgroundColor: "rgba(255, 201, 14, 0.5)",
                fill: false,
            }]
        },
        options: {
            responsive: true,
            // title: {
            //     display: true,
            //     text: '막대 차트 테스트'
            // },
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'application ID'
                    },
                }],
                yAxes: [{
                    display: true,
                    ticks: {
                        autoSkip: false,
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'count'
                    }
                }]
            }
        }
        });
    }
    function format ( d ) {
        return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
            '<tr>'+
                '<td>packet Count:</td>'+
                '<td>'+d.statistics.packetCount+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>packet Rate:</td>'+
                '<td>'+d.statistics.packetRate+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>byte Count:</td>'+
                '<td>'+d.statistics.byteCount+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>byte Rate:</td>'+
                '<td>'+d.statistics.byteRate+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>rtt Average:</td>'+
                '<td>'+d.statistics.rttAverage+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>srt Average:</td>'+
                '<td>'+d.statistics.srtAverage+'</td>'+
            '</tr>'+
        '</table>';
    }
    function FlowTable(chartdata){
        var table = $('#FlowdataTable').DataTable({
            "data": chartdata,
            "responsive": true, 
            "columns": [
                { data: null }, 
                { data: "subject.ipAddress" },
                { data: null, render: function ( data, type, row ) {
                    return data.subject.portProtocol.port+'/'+data.subject.portProtocol.protocol;
                }},
                { data: "peer.ipAddress" },
                // { data: "peer.portProtocol.port" },
                { data: null, render: function ( data, type, row ) {
                    return data.peer.portProtocol.port+'/'+data.peer.portProtocol.protocol;
                }},
                { data: "peer.hostGroupname" },
                { data: "applicationId" },
                { data: "statistics.firstActiveTime" },
                {
                    "className": 'dt-control',
                    "orderable": false,
                    data: null,
                    "defaultContent": ''
                },
            ],
            "columnDefs": [{
                "searchable": false,
                "orderable": false,
                "targets": 0
            }],
            select: {
                style: 'os',
                selector: 'td:not(:last-child)',
            }
        });
        table.on('order.dt search.dt', function () {
                table.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();
        console.log(table.rows().count());
        // document.getElementById('HostlistLength').innerHTML = 'The number of active host list :' + table.rows().count()
        $('#FlowdataTable tbody').on('click', 'td.dt-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row(tr);
     
            if (row.child.isShown()) {
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                row.child(format(row.data())).show();
                tr.addClass('shown');
            }
        } );
    };
</script>
{% endblock %}